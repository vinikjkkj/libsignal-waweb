["WABinary","WACryptoDependencies","WACryptoLibraryConfig","WALogger","WAResultOrError","WASignalCipher","WASignalGroupSession","WASignalKeys","WASignalOther","WASignalSessions","WASignalSignatures","WASignalWhisperTextProtocol.pb","WASignalWhitepaper","asyncToGeneratorRuntime","decodeProtobuf","encodeProtobuf"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j=64;function a(a,b){return k.apply(this,arguments)}function k(){k=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){a=n(a);if(!a.success)return a;a=a.value;var c=a.senderKeyId,e=a.iteration,f=a.signingKeyPublic;a=a.chainKey;c=(yield d("WASignalWhitepaper").initiateSenderKeySessionIncoming(c,e,f,a,b));return d("WAResultOrError").makeResult(c)});return k.apply(this,arguments)}function c(a){a=d("WASignalGroupSession").serializeSenderKeyState(a);var b=new(d("WABinary").Binary)();b.writeUint8(d("WASignalCipher").versionByte(d("WASignalGroupSession").FORMAT_VERSION,d("WASignalGroupSession").FORMAT_VERSION));d("encodeProtobuf").encodeProtobuf(d("WASignalWhisperTextProtocol.pb").SenderKeyDistributionMessageSpec,{id:a.senderKeyId,iteration:d("WASignalSessions").definedOrThrow(a.senderChainKey,"senderChainKey").iteration,chainKey:d("WASignalSessions").definedOrThrow(a.senderChainKey,"senderChainKey").seed,signingKey:d("WASignalSessions").definedOrThrow(a.senderSigningKey,"senderSigningKey")["public"]},b);return b.readByteArrayView()}function e(a,b){return l.apply(this,arguments)}function l(){l=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){if(!a.senderKeyStates||a.senderKeyStates.length===0)return d("WAResultOrError").makeError("errSignalNoSession");var c=a.senderKeyStates[a.senderKeyStates.length-1],e=(yield d("WASignalWhitepaper").deriveSenderKeyMsgKey(c.senderKeyChainKey.nextMsgIndex,c.senderKeyChainKey.chainKey)),f=e[0];e=e[1];var g=(yield p(e.seed)),h=g[0];g=g[1];g=(yield d("WACryptoDependencies").getCrypto().subtle.encrypt({name:"AES-CBC",iv:g},h,b));h=new(d("WABinary").Binary)();d("encodeProtobuf").encodeProtobuf(d("WASignalWhisperTextProtocol.pb").SenderKeyMessageSpec,{id:c.senderKeyId,iteration:e.iteration,ciphertext:g},h);b=new(d("WABinary").Binary)();b.writeUint8(d("WASignalCipher").versionByte(d("WASignalGroupSession").FORMAT_VERSION,d("WASignalGroupSession").FORMAT_VERSION));b.writeBinary(h);g=d("WASignalKeys").makeKeyPairFromSerialized(d("WASignalSessions").definedOrThrow(c.senderSigningKeyPrivate,"senderSigningKeyPrivate"),c.senderSigningKeyPublic);g=d("WASignalSignatures").signSenderKeyMessage(g,b.readByteArrayView());b=new(d("WABinary").Binary)();b.writeUint8(d("WASignalCipher").versionByte(d("WASignalGroupSession").FORMAT_VERSION,d("WASignalGroupSession").FORMAT_VERSION));b.writeBinary(h);b.writeByteArray(g);h=d("WASignalGroupSession").makeSenderKeyChainKey(e.iteration+1,f);g=d("WASignalGroupSession").updateSessionWithUpdatedSenderKeyState(a,d("WASignalGroupSession").makeSenderKeyState(c.senderSigningKeyPublic,c.senderSigningKeyPrivate,h,c.senderKeyId,c.unusedMsgKeys));return d("WAResultOrError").makeResult([g,b.readByteArrayView()])});return l.apply(this,arguments)}function f(a,b){return m.apply(this,arguments)}function m(){m=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){var c=b.senderKeyMessageId,e=b.iteration,f=b.ciphertext;b=b.versionContentMac;c=d("WASignalGroupSession").findSenderKeyState(a,c);if(c==null)return d("WAResultOrError").makeError("errSignalNoSession");var g=c.senderSigningKeyPublic;b=r(b,g);if(!b)return d("WAResultOrError").makeError("errSignalInvalidKey");g=(yield s(c,e));if(!g.success)return g;b=g.value;c=b.msgKey;e=d("WASignalGroupSession").updateSessionWithUpdatedSenderKeyState(a,b.updatedSenderKeyState);g=(yield p(c.seed));a=g[0];b=g[1];c=(yield d("WACryptoDependencies").getCrypto().subtle.decrypt({name:"AES-CBC",iv:b},a,f));return d("WAResultOrError").makeResult([e,c])});return m.apply(this,arguments)}function n(a){var b,c,e,f;try{a=d("WASignalCipher").readContent(a,d("WASignalGroupSession").FORMAT_VERSION,0);if(!a.success)return a;a=d("decodeProtobuf").decodeProtobuf(d("WASignalWhisperTextProtocol.pb").SenderKeyDistributionMessageSpec,a.value);b=a.id;c=a.iteration;var g=d("WASignalSessions").bytesOrThrow(a.signingKey,33,"signingKey");e=d("WASignalKeys").castToSerializedPubKey(g);f=d("WASignalSessions").bytesOrThrow(a.chainKey,32,"chainKey");if(b==null||c==null)return d("WAResultOrError").makeError("errSignalGrpInvalidProtoFormat")}catch(a){d("WALogger").DEV(h||(h=babelHelpers.taggedTemplateLiteralLoose(["deserializeSenderKeyDistributionMsg error ",""])),a);return d("WAResultOrError").makeError("errSignalGrpInvalidKeyFormat")}return d("WAResultOrError").makeResult({senderKeyId:b,iteration:c,signingKeyPublic:e,chainKey:f})}function o(a){if(a.length<1)return d("WAResultOrError").makeError("errSignalGrpVersionContentEmpty");var b=a[0]>>>4;if(b!==d("WASignalGroupSession").FORMAT_VERSION)return b<d("WASignalGroupSession").FORMAT_VERSION?d("WAResultOrError").makeError("errSignalLegacyMsg"):d("WAResultOrError").makeError("errSignalInvalidVersion");if(a.length<1+j)return d("WAResultOrError").makeError("errSignalGrpInvalidVersionContentLength");var c,e,f;try{b=a.subarray(1,-j);b=d("decodeProtobuf").decodeProtobuf(d("WASignalWhisperTextProtocol.pb").SenderKeyMessageSpec,b);c=b.id;e=b.iteration;f=b.ciphertext;if(c==null||e==null||f==null)return d("WAResultOrError").makeError("errSignalGrpSenderKeyInvalidProtoFormat")}catch(a){d("WALogger").ERROR(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Exception caught during SenderKeyMessageSpec Proto: ",""])),a);return d("WAResultOrError").makeError("errSignalGrpSenderKeyProtoError")}return d("WAResultOrError").makeResult({senderKeyMessageId:c,iteration:e,ciphertext:new Uint8Array(f),versionContentMac:a})}function p(a){return q.apply(this,arguments)}function q(){q=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a=new(d("WABinary").Binary)(a);var b=d("WASignalOther").readBytes(a,16);a=d("WASignalOther").readBytes(a,32);return[yield d("WASignalOther").makeCryptoKey(a,"aes-cbc"),b]});return q.apply(this,arguments)}function r(a,b){var c=a.subarray(a.length-j);a=a.subarray(0,a.length-j);return d("WASignalSignatures").verifyMsgSignalVariant(b,a,d("WASignalOther").toBytes(d("WASignalOther").toBuffer(c),64))}function s(a,b){return t.apply(this,arguments)}function t(){t=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){var c=a,e=b-c.senderKeyChainKey.nextMsgIndex,f=d("WACryptoLibraryConfig").getCryptoLibraryConfig().signalFutureMessagesMax;if(e>f)return d("WAResultOrError").makeError("errSignalGrpTooManyMessagesInFuture");f=a.unusedMsgKeys||[];if(e<0){var g=f.findIndex(function(a){return a.iteration===b});return g===-1?d("WAResultOrError").makeError("errDuplicateMsg"):d("WAResultOrError").makeResult({msgKey:f[g],updatedSenderKeyState:d("WASignalGroupSession").makeSenderKeyState(c.senderSigningKeyPublic,c.senderSigningKeyPrivate,c.senderKeyChainKey,c.senderKeyId,u(f,g))})}g=c.senderKeyChainKey.nextMsgIndex;var h=(yield d("WASignalWhitepaper").deriveSenderKeyMsgKey(g,c.senderKeyChainKey.chainKey)),i=h[0];h=h[1];var j=null;if(e>0){e=e+f.length-d("WASignalCipher").MAX_UNUSED_KEYS;e>0?(j=f.slice(e),e-=f.length):j=f.slice();for(g=g+1;g<=b;g++){e>0?e--:j.push(h);var k=(yield d("WASignalWhitepaper").deriveSenderKeyMsgKey(g,i));i=k[0];h=k[1]}}return d("WAResultOrError").makeResult({msgKey:h,updatedSenderKeyState:d("WASignalGroupSession").makeSenderKeyState(c.senderSigningKeyPublic,c.senderSigningKeyPrivate,d("WASignalGroupSession").makeSenderKeyChainKey(b+1,i),a.senderKeyId,j||f)})});return t.apply(this,arguments)}function u(a,b){var c=[];for(var d=0;d<a.length;d++)d!==b&&c.push(a[d]);return c}g.processSenderKeyDistributionMsg=a;g.createSenderKeyDistributionProto=c;g.encryptSenderKeyMsgWithSession=e;g.decryptSenderKeyMsgFromSession=f;g.deserializeSenderKeyMsg=o}),98);
